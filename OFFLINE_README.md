# 离线笔记功能

NoteOL 支持完整的离线笔记创建和编辑功能，即使在网络断开的情况下也能正常使用。

## 功能特性

### ✅ 已实现功能

1. **离线笔记创建**
   - 网络断开时仍可创建新笔记
   - 本地生成唯一ID存储
   - 自动同步到服务器（网络恢复后）

2. **离线内容编辑**
   - 基于 Y.js 和 IndexedDB 的本地存储
   - 支持富文本编辑、标题、标签等
   - 编辑内容实时保存到本地

3. **自动同步机制**
   - 网络恢复时自动检测并同步离线笔记
   - 冲突解决基于 Y.js CRDT 算法
   - 同步状态实时反馈

4. **用户界面标识**
   - 离线笔记在列表中显示橙色边框和"离线"标识
   - 编辑器显示"离线笔记"状态指示器
   - 顶部栏显示"离线保存"状态

## 使用方法

### 创建离线笔记

1. **断开网络连接**（或在网络不稳定环境下）
2. 点击笔记列表中的"新建笔记"按钮
3. 系统会显示"笔记已创建 (离线模式)"提示
4. 笔记会出现在列表中，带有橙色边框和"离线"标识

### 编辑离线笔记

1. 点击离线笔记进入编辑模式
2. 编辑器会显示"离线笔记"状态
3. 所有编辑内容自动保存到本地 IndexedDB
4. 顶部显示"离线保存"状态指示器

### 同步到服务器

1. **恢复网络连接**
2. 系统自动检测并开始同步离线笔记
3. 显示同步进度提示（"已同步 X 篇离线创建的笔记"）
4. 同步完成后，离线笔记变为普通在线笔记
5. 橙色标识消失，显示正常连接状态

## 技术实现

### 核心组件

1. **OfflineManager 类** (`hooks/use-offline.ts`)
   - IndexedDB 数据库管理
   - 离线笔记 CRUD 操作
   - 网络状态监听
   - 自动同步逻辑

2. **离线笔记类型** (`types/offline.ts`)
   - `OfflineNote`: 离线笔记数据结构
   - `OfflineOperation`: 操作队列结构
   - `SyncResult`: 同步结果结构

3. **UI 组件更新**
   - `note-list.tsx`: 显示离线笔记列表
   - `note-detail.tsx`: 支持离线笔记编辑
   - `note-editor.tsx`: 离线状态指示器

### 数据流

```
离线创建:
用户点击创建 → OfflineManager.createOfflineNote() → IndexedDB 存储 → UI 显示

网络恢复:
网络监听器 → OfflineManager.syncPendingNotes() → API 调用 → 服务器存储 → UI 更新

编辑保存:
Y.js 变更 → IndexedDB 自动保存 → 网络恢复时同步到服务器
```

### 存储架构

```
IndexedDB 数据库: noteol_offline
├── offline_notes: 离线笔记存储
│   ├── id (主键)
│   ├── title, content, tags
│   ├── repositoryId
│   ├── status (pending/syncing/synced/failed)
│   └── createdAt, updatedAt
└── offline_operations: 操作队列存储
```

## 注意事项

1. **数据持久性**: 离线笔记存储在浏览器 IndexedDB 中，清除浏览器数据会导致丢失
2. **同步时机**: 只有在网络恢复且用户活跃时才会自动同步
3. **冲突解决**: 基于 Y.js 的 CRDT 算法，自动处理并发编辑冲突
4. **权限控制**: 离线创建的笔记默认为创建者所有权
5. **存储限制**: IndexedDB 存储大小受浏览器限制

## 故障排除

### 离线笔记不显示

- 检查浏览器是否支持 IndexedDB
- 尝试刷新页面
- 检查控制台是否有错误信息

### 同步失败

- 检查网络连接
- 查看同步错误提示
- 手动刷新页面重试

### 数据丢失

- 确保不要清除浏览器数据
- 建议定期备份重要笔记
- 网络恢复后及时同步
