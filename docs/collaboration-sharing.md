# 协作与分享模块 (Collaboration & Sharing)

## 功能概述

协作与分享模块支持多用户实时协作编辑笔记，并提供安全的分享链接功能。用户可以邀请协作者共同编辑笔记，或生成分享链接让他人访问笔记。

## 实现方式

### 技术栈

- **Y.js**: 实时协作数据结构和冲突解决
- **Hocuspocus**: Y.js 协作服务器提供者
- **Prisma**: 协作权限和分享链接数据存储
- **NextAuth**: 用户身份验证
- **随机令牌**: 安全的分享链接生成

### 核心功能

1. **实时协作**: 多用户同时编辑，操作转换确保数据一致性
2. **权限管理**: 支持所有者、管理员、编辑者、观察者四种角色
3. **分享链接**: 生成安全的分享链接，支持权限控制和过期时间
4. **协作者管理**: 添加、移除协作者，管理权限
5. **光标显示**: 显示其他用户的编辑位置和身份

### 协作机制

- **操作转换**: Y.js 的 CRDT 算法确保并发编辑的数据一致性
- **状态同步**: 通过 WebSocket 实时同步编辑状态
- **冲突解决**: 自动解决编辑冲突，无需用户手动处理

## 重要文件

### 核心组件

- `components/editor/share-dialog.tsx`: 分享链接生成对话框
- `components/editor/note-editor.tsx`: 集成协作功能的编辑器

### API 路由

- `app/api/collaboration/share-links/route.ts`: 分享链接创建 API
- `app/api/collaboration/share-links/[id]/route.ts`: 分享链接管理 API
- `app/api/collaboration/auth/route.ts`: 协作认证 API

### 页面文件

- `app/share/claim/page.tsx`: 分享链接认领页面

### 类型定义

- `types/collaboration.ts`: 协作相关类型定义

### 数据库模型

- `prisma/schema.prisma`: NoteCollaborator 和 ShareLink 模型

## 亮点

1. **实时协作**: 真正的实时多用户协作，支持光标显示和身份标识
2. **权限分层**: 细粒度的权限控制，支持四种访问级别
3. **安全分享**: 基于令牌的分享链接，支持过期时间和权限控制
4. **冲突解决**: 自动处理并发编辑冲突，确保数据一致性
5. **离线支持**: 在协作模块中集成离线编辑能力

## 注意事项和坑

1. **Y.js 集成**: 需要正确配置 Y.js 文档和提供者，避免内存泄漏
2. **WebSocket 连接**: 需要处理连接断开和重连逻辑
3. **权限验证**: 协作权限需要在客户端和服务端都进行验证
4. **令牌安全**: 分享令牌需要足够随机，防止暴力破解
5. **过期处理**: 分享链接需要定期清理过期记录
6. **并发控制**: 高并发场景下的性能和一致性保证
7. **数据同步**: 离线编辑后的数据同步逻辑复杂
8. **用户体验**: 协作时的光标和身份显示需要优化

## 依赖关系

- 依赖于认证模块的用户身份验证
- 与笔记管理模块深度集成
- 使用 Y.js 和 Hocuspocus 进行实时协作
- 依赖数据库的权限和分享数据存储
