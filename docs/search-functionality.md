# 搜索功能模块 (Search Functionality)

## 功能概述

搜索功能模块提供强大的全局搜索能力，支持在笔记标题、内容、标签和知识库中进行全文搜索。用户可以通过快捷键快速打开搜索界面，支持精确搜索和模糊匹配。

## 实现方式

### 技术栈

- **Command Component**: 基于 Radix UI 的命令面板组件
- **React Query**: 数据获取和缓存
- **防抖 Hook**: 优化搜索请求频率
- **Prisma**: 数据库全文搜索
- **HTML 解析**: 内容预览和关键词高亮

### 核心功能

1. **多类型搜索**: 支持标题、内容、标签、知识库的分类搜索
2. **快捷键支持**: Cmd/Ctrl + K 快速打开搜索
3. **实时搜索**: 防抖优化，300ms 延迟触发搜索
4. **智能分组**: 按匹配类型分组显示结果
5. **内容预览**: 搜索结果显示内容摘要和关键词上下文
6. **权限控制**: 只搜索用户有权限访问的笔记

### 搜索语法

- `#标签名`: 搜索包含特定标签的笔记
- `@知识库名`: 搜索特定知识库中的笔记
- `title:关键词`: 仅在标题中搜索
- `content:关键词`: 仅在内容中搜索
- `关键词`: 全局搜索（标题、内容、标签）

## 重要文件

### 核心组件

- `components/global-search.tsx`: 全局搜索组件，实现搜索界面和逻辑

### API 路由

- `app/api/search/route.ts`: 搜索 API，支持多种搜索类型和权限控制

### 类型定义

- `types/search.ts`: 搜索相关类型定义

### 工具函数

- `lib/utils.ts`: `stripHtml` 函数用于内容预处理
- `hooks/use-debounce.ts`: 防抖 Hook 优化搜索性能

## 亮点

1. **用户体验**: 快捷键唤起，实时反馈，无需页面跳转
2. **搜索语法**: 支持多种搜索语法，满足不同搜索需求
3. **性能优化**: 防抖减少请求频率，并发查询提高响应速度
4. **内容预览**: 智能摘要显示，突出显示搜索关键词
5. **权限安全**: 服务端严格的权限检查，确保数据安全
6. **响应式设计**: 支持移动端和桌面端的不同交互方式

## 注意事项和坑

1. **数据库性能**: 全文搜索在大数据量下可能性能较慢，需要考虑索引优化
2. **HTML 解析**: `stripHtml` 函数需要正确处理各种 HTML 标签
3. **权限过滤**: 复杂的权限查询条件可能影响查询性能
4. **内容截断**: 内容预览的截断逻辑需要正确处理多字节字符
5. **搜索语法解析**: 前端和后端的搜索语法解析需要保持一致
6. **防抖时机**: 防抖延迟时间需要平衡用户体验和服务器负载
7. **结果去重**: 不同搜索类型可能返回相同笔记，需要去重处理
8. **错误处理**: 网络错误时需要优雅降级，不影响用户体验

## 依赖关系

- 依赖于认证模块获取用户身份和权限
- 与笔记管理模块共享数据模型
- 使用 UI 组件库的 Command 组件
- 依赖工具库的 HTML 处理函数
